<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feet Meme Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        /* Custom styles for loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Ensure images fit within their containers without distortion */
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ensures the entire image is visible, maintaining aspect ratio */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl flex flex-col md:flex-row gap-6">

        <!-- Controls Section -->
        <div class="md:w-1/3 flex flex-col items-center justify-start py-4 space-y-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Feet Meme Generator</h1>

            <!-- Profile Picture Upload -->
            <div class="w-full">
                <label for="profileUpload" class="block text-sm font-medium text-gray-700 mb-2">Upload Profile Picture</label>
                <input type="file" id="profileUpload" accept="image/*" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <p id="fileName" class="mt-2 text-sm text-gray-500 text-center"></p>
            </div>

            <!-- Generate Button -->
            <button id="generateBtn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                <span id="generateBtnText">Generate Feet Pic</span>
                <div id="loadingSpinner" class="loader hidden"></div>
            </button>

            <!-- Save Button -->
            <button id="saveBtn" class="w-full bg-gradient-to-r from-green-400 to-teal-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:from-green-500 hover:to-teal-600 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Save Meme
            </button>

            <!-- Status Message -->
            <p id="statusMessage" class="mt-4 text-sm text-gray-600 text-center"></p>
        </div>

        <!-- Image Display Section -->
        <div class="md:w-2/3 flex flex-col items-center justify-center space-y-6">
            <!-- Uploaded Profile Picture Container -->
            <div class="w-full bg-gray-50 border border-gray-200 rounded-lg overflow-hidden shadow-inner flex items-center justify-center min-h-[200px] md:min-h-[250px] aspect-video image-container">
                <img id="uploadedImage" src="https://placehold.co/600x400/e0e0e0/ffffff?text=Your+Profile+Pic" alt="Uploaded Profile Picture" class="w-full h-auto object-contain rounded-lg">
            </div>

            <!-- Generated Foot Image Container (will show the combined meme) -->
            <div class="w-full bg-gray-50 border border-gray-200 rounded-lg overflow-hidden shadow-inner flex items-center justify-center min-h-[200px] md:min-h-[250px] aspect-video image-container">
                <img id="generatedFootImage" src="https://placehold.co/600x400/e0e0e0/ffffff?text=Generated+Feet+Pic" alt="Generated Feet Picture" class="w-full h-auto object-contain rounded-lg">
            </div>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const profileUpload = document.getElementById('profileUpload');
        const fileNameLabel = document.getElementById('fileName');
        const generateBtn = document.getElementById('generateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const uploadedImage = document.getElementById('uploadedImage');
        const generatedFootImage = document.getElementById('generatedFootImage');
        const statusMessage = document.getElementById('statusMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const generateBtnText = document.getElementById('generateBtnText');

        // List of random prompts for foot image generation
        const basePrompts = [
            "bare feet", "feet in sandals", "feet with ankle bracelet", "feet on beach sand",
            "fantasy RPG character feet", "feet of a warrior from a fantasy realm",
            "feet of a magical creature", "mythical creature feet", "feet from a sci-fi alien",
            "feet with unique patterns", "feet with elaborate tattoos", "feet in a whimsical setting"
        ];

        const sizes = ["size 18 feet", "size 20 feet", "size 22 feet", "size 24 feet"];
        const genders = ["male", "female", "gender-neutral"];
        const skinColors = ["pale skin", "tanned skin", "dark skin", "olive skin", "albino skin"];
        const nailColors = ["red nail polish", "blue nail polish", "green nail polish", "yellow nail polish", "purple nail polish", "black nail polish", "white nail polish", "rainbow nail polish", "polka dot nail polish", "no nail polish"];
        const nailSizes = ["long nails", "short nails", "neatly trimmed nails", "overgrown nails"];

        const monsterFeatures = [
            "extra toes", "less toes", "claws", "scales", "fur", "hooves", "tentacles for toes",
            "glowing eyes on feet", "horror-themed", "alien-like", "with sharp talons", "webbed toes"
        ];

        const actions = [
            "kicking a soccer ball", "at a nail salon", "walking on a beach", "covered in mud",
            "with flies or bugs all over them", "in slime", "grabbing a spoon with toes",
            "on a giant mushroom", "stepping on little smurfs", "stepping on a tiny village",
            "being burnt by being in lava", "dancing gracefully", "running through a forest",
            "resting by a fireplace", "splashing in a puddle", "climbing a rope", "playing a piano with toes"
        ];

        const styles = [
            "minecraft-esque", "pixelated", "realistic", "anime", "cinematic", "foot model style",
            "hollywood style", "comic book style", "abstract art style", "impressionistic", "gothic art style",
            "vaporwave aesthetic", "steampunk style", "cyberpunk style", "surrealism"
        ];

        // Event listener for profile picture upload
        profileUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                fileNameLabel.textContent = `Selected: ${file.name}`;
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage.src = e.target.result;
                    generateBtn.disabled = false; // Enable generate button once image is selected
                    statusMessage.textContent = 'Ready to generate feet pic!';
                };
                reader.readAsDataURL(file);
            } else {
                fileNameLabel.textContent = 'No image selected';
                uploadedImage.src = "https://placehold.co/600x400/e0e0e0/ffffff?text=Your+Profile+Pic";
                generateBtn.disabled = true;
                saveBtn.disabled = true;
                statusMessage.textContent = 'Please select a profile picture.';
            }
        });

        // Function to resize and crop an image to fit a target size
        function resizeAndCrop(img, targetWidth, targetHeight) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = targetWidth;
            canvas.height = targetHeight;

            const imgAspectRatio = img.width / img.height;
            const targetAspectRatio = targetWidth / targetHeight;

            let sx, sy, sWidth, sHeight; // Source rectangle
            let dx = 0, dy = 0, dWidth = targetWidth, dHeight = targetHeight; // Destination rectangle

            if (imgAspectRatio > targetAspectRatio) {
                // Image is wider than target, crop horizontally
                sHeight = img.height;
                sWidth = sHeight * targetAspectRatio;
                sx = (img.width - sWidth) / 2;
                sy = 0;
            } else {
                // Image is taller than target, crop vertically
                sWidth = img.width;
                sHeight = sWidth / targetAspectRatio;
                sy = (img.height - sHeight) / 2;
                sx = 0;
            }

            ctx.drawImage(img, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
            return canvas.toDataURL('image/png');
        }


        // Event listener for generate button
        generateBtn.addEventListener('click', async () => {
            if (!profileUpload.files[0]) {
                statusMessage.textContent = 'Please upload a profile picture first.';
                return;
            }

            // Disable buttons and show loading state
            generateBtn.disabled = true;
            saveBtn.disabled = true;
            generateBtnText.textContent = 'Generating...';
            loadingSpinner.classList.remove('hidden');
            statusMessage.textContent = 'Generating your unique feet pic, please wait...';
            generatedFootImage.src = "https://placehold.co/600x400/e0e0e0/ffffff?text=Generating..."; // Placeholder for loading

            // --- Dynamic Prompt Generation ---
            let selectedPromptParts = [];

            // Always start with a base prompt
            selectedPromptParts.push(basePrompts[Math.floor(Math.random() * basePrompts.length)]);

            // Randomly add size, gender, skin color, nail color, nail size
            if (Math.random() < 0.7) selectedPromptParts.push(sizes[Math.floor(Math.random() * sizes.length)]);
            if (Math.random() < 0.7) selectedPromptParts.push(genders[Math.floor(Math.random() * genders.length)]);
            if (Math.random() < 0.7) selectedPromptParts.push(skinColors[Math.floor(Math.random() * skinColors.length)]);
            if (Math.random() < 0.8) selectedPromptParts.push(nailColors[Math.floor(Math.random() * nailColors.length)]);
            if (Math.random() < 0.6) selectedPromptParts.push(nailSizes[Math.floor(Math.random() * nailSizes.length)]);

            // Rare chance for monster feet
            if (Math.random() < 0.2) { // 20% chance for monster feet
                selectedPromptParts.push("monster feet");
                if (Math.random() < 0.7) selectedPromptParts.push(monsterFeatures[Math.floor(Math.random() * monsterFeatures.length)]);
                // If monster feet, higher chance of a "fun factor" action
                if (Math.random() < 0.8) selectedPromptParts.push(actions[Math.floor(Math.random() * actions.length)]);
            } else {
                // Otherwise, a regular chance for a "fun factor" action
                if (Math.random() < 0.5) selectedPromptParts.push(actions[Math.floor(Math.random() * actions.length)]);
            }

            // Always add a style
            selectedPromptParts.push(styles[Math.floor(Math.random() * styles.length)]);

            // Join all parts to form the final prompt
            const finalPrompt = selectedPromptParts.join(", ");
            console.log("Generated Prompt:", finalPrompt); // Log the prompt for debugging

            try {
                // Call the Gemini API to generate the image
                const payload = {
                    instances: { prompt: finalPrompt }, // Use the dynamically generated prompt
                    parameters: { "sampleCount": 1 }
                };
                // IMPORTANT: Replace "YOUR_GOOGLE_API_KEY_HERE" with your actual API key
                const apiKey = "AIzaSyBBdSL8uesGqhgu6F2wS7nzkY8x2GMUVq8"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }

                const result = await response.json();
                let footImageUrl;

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    footImageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    throw new Error('No image data received from API.');
                }

                // Load both images for canvas drawing
                const profileImg = new Image();
                const footImg = new Image();

                const loadProfilePromise = new Promise((resolve, reject) => {
                    profileImg.onload = () => resolve();
                    profileImg.onerror = reject;
                    profileImg.src = uploadedImage.src;
                });

                const loadFootPromise = new Promise((resolve, reject) => {
                    footImg.onload = () => resolve();
                    footImg.onerror = reject;
                    footImg.src = footImageUrl;
                });

                await Promise.all([loadProfilePromise, loadFootPromise]);

                statusMessage.textContent = 'Combining images and adding caption...';

                // Create a canvas for the combined meme
                const memeCanvas = document.createElement('canvas');
                const memeCtx = memeCanvas.getContext('2d');

                // Define dimensions for the combined meme (profile pic + foot pic + caption)
                // Using 1080x960 for each image section, similar to original Python
                const imageSectionHeight = 960;
                const imageSectionWidth = 1080;
                const captionHeight = 100; // Space for the caption
                memeCanvas.width = imageSectionWidth;
                memeCanvas.height = (imageSectionHeight * 2) + captionHeight; // Total height

                // Draw profile image (resized and cropped to fit top half)
                const resizedProfileDataUrl = resizeAndCrop(profileImg, imageSectionWidth, imageSectionHeight);
                const tempProfileImg = new Image();
                await new Promise(resolve => { tempProfileImg.onload = resolve; tempProfileImg.src = resizedProfileDataUrl; });
                memeCtx.drawImage(tempProfileImg, 0, 0, imageSectionWidth, imageSectionHeight);

                // Draw foot image (resized and cropped to fit bottom half, below profile pic)
                const resizedFootDataUrl = resizeAndCrop(footImg, imageSectionWidth, imageSectionHeight);
                const tempFootImg = new Image();
                await new Promise(resolve => { tempFootImg.onload = resolve; tempFootImg.src = resizedFootDataUrl; });
                memeCtx.drawImage(tempFootImg, 0, imageSectionHeight, imageSectionWidth, imageSectionHeight);

                // Add meme caption
                const memeText = "THIS IS THE FEET YOU LIKE BASED ON YOUR PROFILE";
                // Attempt to use 'Impact' font, fallback to generic sans-serif
                memeCtx.font = 'bold 40px Impact, sans-serif';
                memeCtx.textAlign = 'center';
                memeCtx.fillStyle = 'white';
                memeCtx.strokeStyle = 'black';
                memeCtx.lineWidth = 6; // Thicker outline

                // Calculate text position
                const textX = memeCanvas.width / 2;
                const textY = (imageSectionHeight * 2) + (captionHeight / 2) + 10; // Centered in caption area

                // Draw black outline
                memeCtx.strokeText(memeText, textX, textY);
                // Draw white text
                memeCtx.fillText(memeText, textX, textY);

                // Set the generatedFootImage src to the combined meme
                generatedFootImage.src = memeCanvas.toDataURL('image/png');
                saveBtn.disabled = false; // Enable save button
                statusMessage.textContent = 'Meme generated successfully! Click "Save Meme" to download.';

            } catch (error) {
                console.error('Error generating meme:', error);
                statusMessage.textContent = `Error generating meme: ${error.message}. Please try again.`;
                generatedFootImage.src = "https://placehold.co/600x400/e0e0e0/ffffff?text=Error"; // Show error placeholder
            } finally {
                // Re-enable buttons and hide loading state
                generateBtn.disabled = false;
                generateBtnText.textContent = 'Generate Feet Pic';
                loadingSpinner.classList.add('hidden');
            }
        });

        // Event listener for save button
        saveBtn.addEventListener('click', () => {
            const imageUrl = generatedFootImage.src;
            if (imageUrl && imageUrl.startsWith('data:image/png;base64,')) {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `feet_meme_${Date.now()}.png`; // Suggested filename
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                statusMessage.textContent = 'Meme downloaded!';
            } else {
                statusMessage.textContent = 'No meme to save yet!';
            }
        });

        // Initial state setup
        fileNameLabel.textContent = 'No image selected';
        statusMessage.textContent = 'Upload a profile picture to get started!';
    </script>
</body>
</html>
